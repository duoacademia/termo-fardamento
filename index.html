<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DUO Academia — Entrega de Fardamento</title>
  <meta name="description" content="Comprovante de entrega de fardamento com CPF obrigatório, seleção de itens, rúbrica por toque e geração de PDF." />
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e5e7eb; --line:#1f2937; --brand:#3b82f6; --ok:#22c55e; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{height:100%; overflow-x:hidden;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--fg);}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 0 24px;border-bottom:1px solid var(--line)}
    h1{font-size:20px;margin:0;font-weight:700}
    .badge{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:20px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{font-size:16px;margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #1c2536;color:var(--fg);border-radius:10px;padding:12px;outline:none}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    #nome{text-transform:uppercase;}
    .help{font-size:12px;color:var(--muted);margin-top:4px}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .btn{appearance:none;border:1px solid #2a3448;background:#162136;color:#dbeafe;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand); border-color:var(--brand); color:white}
    .btn.success{background:var(--ok); border-color:var(--ok); color:#001a07}
    .btn.danger{background:var(--danger); border-color:var(--danger); color:white}
    .terms{border:1px dashed #334155;border-radius:12px;padding:12px; background:#0b1220;}
    .sig-wrap{background:#0b1220;border:1px solid #1c2536;border-radius:12px;padding:12px}
    canvas{width:100%;height:160px;background:#ffffff;border-radius:8px;border:0;touch-action:none}
    .preview{position:sticky; top:24px; overflow-x:auto;}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1f2937;border:0;margin:12px 0}
    footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}

    /* Printable area (A4) */
    .sheet{background:white;color:#111; width:794px; min-height:1123px; padding:28mm 20mm; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 30px rgba(0,0,0,.15);
      word-spacing:.06em; letter-spacing:.01em; text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; font-kerning:normal;
    }
    .sheet h3, .sheet th, .sheet strong { word-spacing:.08em; letter-spacing:.02em; }
    .sheet h3{margin:0 0 8px}
    .sheet small{color:#555}
    .sheet .section{margin-top:14px}
    .sheet table{width:100%; border-collapse:collapse; font-size:13px}
    .sheet th,.sheet td{border:1px solid #ccc; padding:10px 12px; text-align:left; vertical-align:middle}
    .sheet .sign-img{width:100%; height:120px; max-height:120px; object-fit:contain; display:block; margin:0 auto}
    .sheet .sign-area{display:flex; gap:16px; align-items:flex-end; margin-top:12px}
    .sheet .sign-box{flex:1}
    .sheet .line{height:1px;background:#ccc;margin:6px 0}
    .sheet .brand{display:flex; align-items:flex-start; gap:10px;}
    .sheet .brand img.logo{height:34px; width:auto; display:block;}
    .sheet .brand small{font-size:8px; line-height:1.2; margin-top:2px; display:block;}
    .sheet .brand h3{ margin:0 0 4px; }

    @media (max-width:720px){
      .row{ grid-template-columns: 1fr; }
      .card{ padding:16px; }
      .wrap{ padding:16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>DUO Academia · Entrega de Fardamento</h1>
        <div class="badge">Preencha os dados, assine (rúbrica) e gere o PDF do recibo.</div>
      </div>
      <div class="badge">v1.0 • Fardamento</div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>1) Identificação</h2>
        <div class="row">
          <div>
            <label for="nome">Nome completo</label>
            <input id="nome" placeholder="Ex.: JOÃO DA SILVA" />
            <div class="help">Obrigatório</div>
          </div>
          <div>
            <label for="cpf">CPF</label>
            <input id="cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" />
            <div class="help">Obrigatório</div>
          </div>
        </div>

        <h2 style="margin-top:18px">2) Item Entregue</h2>
        <div class="row">
          <div>
            <label for="material">Material</label>
            <select id="material">
              <option value="">Selecione...</option>
              <option>Farda</option>
              <option>Casaco</option>
            </select>
            <div class="help">Obrigatório</div>
          </div>
          <div>
            <label for="quantidade">Quantidade</label>
            <input id="quantidade" type="number" min="1" max="20" step="1" placeholder="Ex.: 1" />
            <div class="help">Obrigatório (mín. 1)</div>
          </div>
        </div>
        <div class="row row-1">
          <div>
            <label for="tamanho">Tamanho</label>
            <select id="tamanho">
              <option value="">Selecione...</option>
              <option>PP</option>
              <option>P</option>
              <option>M</option>
              <option>G</option>
              <option>GG</option>
              <option>XG</option>
            </select>
            <div class="help">Obrigatório</div>
          </div>
        </div>

        <h2 style="margin-top:18px">3) Termo e Rúbrica</h2>
        <div class="terms" id="termo_texto">
          <div style="font-size:13px; line-height:1.55">
            <strong>TERMO:</strong> Declaro ter recebido da empresa <strong>DUO Academia</strong>, o uniforme abaixo discriminado, 
            me comprometendo a utilizá-lo(s) somente para fins laborais durante toda a jornada de trabalho e devolvê-lo no término do vínculo contratual.
            <br><br>
            <em>Garanhuns, <span id="termo_data"></span>.</em>
          </div>
        </div>

        <div class="sig-wrap">
          <label>Assine (rúbrica) no quadro abaixo</label>
          <canvas id="signaturePad" width="900" height="350" aria-label="Área para assinatura com o dedo ou mouse"></canvas>
          <div class="buttons">
            <button class="btn" id="btnLimpar">Limpar rúbrica</button>
          </div>
        </div>

        <div class="buttons">
          <button class="btn success" id="btnPDF">Gerar PDF</button>
          <button class="btn danger" id="btnReset">Resetar formulário</button>
        </div>
      </div>

      <div class="card preview">
        <h2>Pré-visualização do Recibo (PDF)</h2>
        <div class="help">Atualiza automaticamente conforme você preenche.</div>
        <div id="printArea" class="sheet" aria-label="Área imprimível">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div class="brand">
              <img id="sheet_logo" class="logo" alt="Logo DUO" crossorigin="anonymous" />
              <div>
                <h3>DUO ACADEMIA</h3>
                <small>Av. Simoa Gomes, 726 – Heliópolis · R. Dom José, 187 – Santo Antônio<br>
                (87) 9.9666-0021 | (87) 9.9934-1230 · coordenacaoduoacademia@gmail.com<br></small>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px;color:#444">Código: <span id="doc_id"></span></div>
              <div style="font-size:12px;color:#444">Data: <span id="doc_data"></span></div>
            </div>
          </div>
          <div class="line"></div>

          <div class="section">
            <table>
              <tr><th colspan="2">COMPROVANTE DE ENTREGA DE FARDAMENTO</th></tr>
              <tr><td style="width:26%">Nome completo</td><td id="pv_nome"></td></tr>
              <tr><td>CPF</td><td id="pv_cpf"></td></tr>
            </table>
          </div>

          <div class="section">
            <table>
              <tr><th style="width:26%">Material</th><th style="width:18%">Quantidade</th><th style="width:18%">Tamanho</th><th>Observações</th></tr>
              <tr>
                <td id="pv_material"></td>
                <td id="pv_quantidade"></td>
                <td id="pv_tamanho"></td>
                <td id="pv_obs">—</td>
              </tr>
            </table>
          </div>

          <div class="section">
            <table>
              <tr><th>TERMO DE RESPONSABILIDADE</th></tr>
              <tr>
                <td id="pv_termo" style="font-size:13px; line-height:1.55">
                  Declaro ter recebido da empresa DUO Academia, o uniforme abaixo discriminado, me comprometendo a utilizá-lo(s) somente para fins laborais
                  durante toda a jornada de trabalho e devolvê-lo no término do vínculo contratual.
                  <br><br>
                  <em>Garanhuns, <span id="pv_termo_data"></span>.</em>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="sign-area">
                    <div class="sign-box">
                      <img id="pv_assinatura" class="sign-img" alt="Assinatura/Rúbrica" />
                      <div class="line"></div>
                      <div style="font-size:12px;color:#555;text-align:center">Rúbrica do(a) Colaborador(a)</div>
                    </div>
                  </div>
                </td>
              </tr>
            </table>
          </div>

        </div>
        <footer>
          Dica: você também pode usar <strong>Imprimir &gt; Salvar como PDF</strong>, se preferir.
        </footer>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // Helpers
    const $ = (s) => document.querySelector(s);
    const onlyDigits = (v) => (v||'').replace(/\D+/g,'');
    const maskCPF = (v) => {
      v = onlyDigits(v).slice(0,11);
      return v.replace(/(\d{3})(\d)/, '$1.$2')
              .replace(/(\d{3})(\d)/, '$1.$2')
              .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    };
    function isValidCPF(cpf){
      cpf = onlyDigits(cpf);
      if (cpf.length !== 11) return false;
      if (/^(\d)\1{10}$/.test(cpf)) return false;
      let sum = 0, rest;
      for (let i=1;i<=9;i++) sum += parseInt(cpf.substring(i-1,i)) * (11 - i);
      rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(cpf.substring(9,10))) return false;
      sum = 0; for (let i=1;i<=10;i++) sum += parseInt(cpf.substring(i-1,i)) * (12 - i);
      rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; return rest === parseInt(cpf.substring(10,11));
    }
    function normalizeName(s){
      const noAccents = (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'');
      return noAccents.replace(/[^A-Za-z0-9]/g,'').toUpperCase();
    }

    // Logo opcional via ?logo=
    const DEFAULT_LOGO = 'logo.png';
    const urlParamLogo = new URLSearchParams(location.search).get('logo');
    const logoSrc = urlParamLogo || DEFAULT_LOGO;
    (function setLogo(){ const img=$('#sheet_logo'); if(img){img.src=logoSrc; img.setAttribute('crossorigin','anonymous');} })();

    // Data de hoje (Fortaleza) nas áreas
    function setTodayBR(){
      const dt = new Date();
      const parts = new Intl.DateTimeFormat('pt-BR',{timeZone:'America/Fortaleza', day:'2-digit', month:'2-digit', year:'numeric'}).formatToParts(dt);
      const dd = parts.find(p=>p.type==='day').value;
      const mm = parts.find(p=>p.type==='month').value;
      const yyyy = parts.find(p=>p.type==='year').value;
      $('#doc_data').textContent = `${dd}/${mm}/${yyyy}`;
      $('#termo_data').textContent = `${dd}/${mm}/${yyyy}`;
      $('#pv_termo_data').textContent = `${dd}/${mm}/${yyyy}`;
    }

    // Signature Pad
    let signaturePad, canvas;
    function setupSignaturePad(){
      canvas = document.getElementById('signaturePad');
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio);
      signaturePad = new SignaturePad(canvas, { backgroundColor:'#fff', penColor:'#111827', minWidth:0.7, maxWidth:2.0, throttle:0 });
      canvas.addEventListener('mouseup', renderPreview);
      canvas.addEventListener('touchend', renderPreview);
      $('#btnLimpar').addEventListener('click', (e)=>{ e.preventDefault(); signaturePad.clear(); renderPreview(); });
      window.addEventListener('resize', ()=>{
        const data = signaturePad.toData();
        const rect = canvas.getBoundingClientRect();
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = rect.width * ratio; canvas.height = rect.height * ratio;
        const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio);
        signaturePad.clear(); signaturePad.fromData(data);
      });
    }

    // Render da prévia
    function renderPreview(){
      // Nome sempre MAIÚSCULO no valor e na prévia
      const nomeRaw = $('#nome').value || '';
      const nomeUpper = nomeRaw.toLocaleUpperCase('pt-BR');
      if (nomeRaw !== nomeUpper) $('#nome').value = nomeUpper;

      $('#pv_nome').textContent = nomeUpper;
      $('#pv_cpf').textContent = $('#cpf').value.trim();

      $('#pv_material').textContent   = $('#material').value || '';
      $('#pv_quantidade').textContent = $('#quantidade').value || '';
      $('#pv_tamanho').textContent    = $('#tamanho').value || '';

      // Assinatura na prévia
      const img = $('#pv_assinatura');
      img.src = (signaturePad && !signaturePad.isEmpty()) ? signaturePad.toDataURL('image/png') : '';
    }

    // Validações e PDF
    async function generatePDF(){
      const nome = ($('#nome').value || '').trim();
      const cpf  = $('#cpf').value.trim();
      const material = $('#material').value;
      const quantidade = parseInt($('#quantidade').value, 10);
      const tamanho = $('#tamanho').value;

      if (!nome) { alert('Informe o nome completo.'); return; }
      if (!isValidCPF(cpf)) { alert('CPF inválido.'); return; }
      if (!material){ alert('Selecione o material.'); return; }
      if (!Number.isInteger(quantidade) || quantidade < 1){ alert('Quantidade inválida.'); return; }
      if (!tamanho){ alert('Selecione o tamanho.'); return; }
      if (!signaturePad || signaturePad.isEmpty()){ alert('Faça a rúbrica para continuar.'); return; }

      // código interno e render final
      $('#doc_id').textContent = new Date().toISOString().replace(/[-:TZ.]/g, '').slice(0, 14);
      renderPreview();

      // Capturar a área A4
      const area = document.getElementById('printArea');
      const canvasImg = await html2canvas(area, { scale: 2, useCORS: true });
      const imgData = canvasImg.toDataURL('image/png');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const w = pageWidth - 20, h = (canvasImg.height * w) / canvasImg.width;
      pdf.addImage(imgData, 'PNG', 10, 10, w, h, undefined, 'FAST');

      // Nome do arquivo
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yyyy = String(now.getFullYear());
      const nomeFile = normalizeName(nome);
      const filename = `FARDAMENTO_${nomeFile}_${dd}${mm}${yyyy}.pdf`;

      pdf.save(filename);
    }

    // Eventos
    ['nome','cpf','material','quantidade','tamanho'].forEach(id => {
      const el = $('#'+id);
      if (!el) return;
      el.addEventListener('input', renderPreview);
      el.addEventListener('change', renderPreview);
    });
    $('#cpf').addEventListener('input', (e)=> e.target.value = maskCPF(e.target.value));
    $('#btnPDF').addEventListener('click', (e)=>{ e.preventDefault(); generatePDF(); });
    $('#btnReset').addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('Limpar todos os campos?')) location.reload(); });

    // Init
    setTodayBR();
    setupSignaturePad();
    renderPreview();
  </script>
</body>
</html>
